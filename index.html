<!DOCTYPE html>
<html>
<head>
  <title>Clon de Google My Maps</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; }
    .leaflet-popup-content input { width: 100%; }
    .toolbar {
      position: absolute;
      top: 10px; left: 10px;
      background: white; padding: 10px;
      z-index: 1000;
      border-radius: 8px;
      box-shadow: 0 0 5px #999;
    }
  </style>
</head>
<body>
<div class="toolbar">
  <button onclick="mode='marker'">📍 Marcar</button>
  <button onclick="mode='line2'">➖ Línea 2 hilos</button>
  <button onclick="mode='line4'">➖ Línea 4 hilos</button>
  <button onclick="mode='troncal'">⚡ Troncal</button>
  <button onclick="save()">💾 Guardar</button>
  <button onclick="load()">📂 Cargar</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([-17.4, -66.15], 13); // Bolivia
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let mode = 'marker';
  let drawingLine = [];
  let allLayers = [];

  map.on('click', function(e) {
    if (mode === 'marker') {
      const marker = L.marker(e.latlng).addTo(map);
      const input = document.createElement("input");
      input.placeholder = "Nombre del punto";
      marker.bindPopup(input);
      marker.on("popupclose", () => {
        const label = input.value || "Sin nombre";
        marker.bindTooltip(label, {permanent: true}).openTooltip();
      });
      allLayers.push(marker);
      marker.openPopup();
    } else if (mode.startsWith('line')) {
      drawingLine.push(e.latlng);
      if (drawingLine.length >= 2) {
        const color = mode === 'line2' ? 'blue' : mode === 'line4' ? 'green' : 'red';
        const polyline = L.polyline(drawingLine, { color, weight: 4 }).addTo(map);
        allLayers.push(polyline);
        drawingLine = [];
      }
    }
  });

  function save() {
    const geojson = allLayers.map(l => l.toGeoJSON());
    localStorage.setItem('mymap', JSON.stringify(geojson));
    alert("Proyecto guardado");
  }

  function load() {
    allLayers.forEach(l => map.removeLayer(l));
    allLayers = [];

    const geojson = JSON.parse(localStorage.getItem('mymap') || "[]");
    geojson.forEach(g => {
      if (g.geometry.type === "Point") {
        const marker = L.marker(g.geometry.coordinates.reverse()).addTo(map);
        marker.bindTooltip("Punto cargado", {permanent: true}).openTooltip();
        allLayers.push(marker);
      } else if (g.geometry.type === "LineString") {
        const color = g.properties.color || "black";
        const line = L.polyline(g.geometry.coordinates.map(c => c.reverse()), { color, weight: 4 }).addTo(map);
        allLayers.push(line);
      }
    });
    alert("Proyecto cargado");
  }
</script>
</body>
</html>
